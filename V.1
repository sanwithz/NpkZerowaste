<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Royal Point</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <!-- Sanwithz Style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sanwithz/Form/sanwithzstyle2.min.css">

  <!-- Sweet Alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Loading Overlay -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <!-- html5 qrcode --> 
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
  .bg-silver {
    background: linear-gradient(135deg, #C0C0C0, #ffffff);
    color: #333;
  }

  .bg-gold {
    background: linear-gradient(135deg, #FFD700, #FFF3B0);
    color: #333;
  }

  .bg-diamond {
/*     background: linear-gradient(135deg, #b9f2ff, #e0f7ff); */
    background: linear-gradient(30deg, #3f87a6, #ebf8e1, #f69d3c);
    color: #333;
  }
    
      #displaySection {
    display: none;
  }
    
    .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
    margin-top: 0;
    margin-bottom: 0;
}
    
        .modal-fullscreen {
      width: 100%;
      max-width: none;
      height: 100%;
      margin: 0;
    }

    .modal-fullscreen .modal-content {
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 0;
    }

    .modal-fullscreen .modal-body {
      overflow-y: auto;
    }
</style>

  
</head>
<body class="bg-light">

  <div class="container mt-2">
<!--       <img src="https://placehold.co/600x200?text=NPK+Net+Zero" class="card-img-top rounded-4" alt="Header"> -->
    
          <img src="https://lh3.googleusercontent.com/d/1M-Ti66KWBq7svidWIpAf-bj-VNPBhtfg" class="card-img-top rounded-4" alt="Header">
    
    <div id="regSection" >
          <div class=" mt-5">
        <h2 class="text-center">ระบบลงทะเบียนใช้งาน</h2>
        <form id="dataForm" class="list mt-3">
            <div class="mb-3">
                <label for="uid" class="form-label disable ">UID</label>
                <input type="text" class="form-control" id="uid" name="uid" readonly>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">ชื่อ - นามสกุล</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="sex" class="form-label">ระดับชั้น</label>
                <select class="form-control" id="room" name="room" required>
                    <option value="">เลือก</option>
                    <option value="ม.1">ม.1</option>
                    <option value="ม.2">ม.2</option>
                    <option value="ม.3">ม.3</option>
                    <option value="ม.4">ม.4</option>
                    <option value="ม.5">ม.5</option>
                    <option value="ม.6">ม.6</option>                  
                </select>
            </div>
            <div class="mb-3">
                <label for="dob" class="form-label">วันเกิด</label>
                <input type="date" class="form-control" id="dob" name="dob" required>
            </div>
            <div class="mb-3">
                <label for="passport" class="form-label">เลขประจำตัวนักเรียน/Passport</label>
                <input type="text" class="form-control" id="passport" name="passport" required>
            </div>
            <div class="mb-3">
                <label for="telephone" class="form-label">เบอร์โทรศัพท์</label>
                <input type="text" class="form-control" id="telephone" name="telephone" required>
            </div>
            <button type="submit" class="btn btn-primary btn-lg w-100">สมัครใช้งาน</button>
        </form>
    </div>


      
    </div>
    
    <div id="displaySection" class="list mt-2">

      
      
      
<!-- User Info in Flex Row -->
<div class="d-flex align-items-center bg-silver p-3 rounded-4 shadow-sm mb-3">
<img id="profilePic" src="https://placehold.co/60x60" class="rounded-circle border border-2 border-white shadow me-3" style="width: 60px; height: 60px;" />

  <div>
    <div class="fw-bold fs-6" id="username">KruBank Sitti</div>
    <div class="text-muted small">
      <span>ชั้น ม.6/99 เลขประจำตัวนักเรียน 99</span><br/>
      <span id="phone"><i class="fas fa-phone"></i> 0906616611</span>
    </div>
  </div>
  <div class="ms-auto text-end">
    <div class="text-warning fw-bold" style="margin-right: 10px;">
      <h2><i class="fas fa-coins"></i></h2> <h2 id="points">100</h2> <h5>พ้อยท์</h5>
    </div>
  </div>
</div>


<div class="text-center mt-2">
        <!-- Progress Curve -->
<div>
  <svg viewBox="0 0 100 50" class="w-100">
    <!-- background circle -->
    <path d="M 10 50 A 40 40 0 0 1 90 50" stroke="#eee" stroke-width="10" fill="none" />
    
    <!-- foreground curve progress -->
    <path id="progressCurve" d="M 10 50 A 40 40 0 0 1 90 50" stroke="#30674c" stroke-width="10" fill="none"
      stroke-dasharray="126" stroke-dashoffset="42" stroke-linecap="round" />
  </svg>
  <div class="text-center mt-2 mb-4 fw-bold">ระดับ Silver</div>
</div>

        
<!--         <div class="progress my-3" style="height: 20px;">
          <div class="progress-bar bg-primary" style="width: 66%;">Silver</div>
        </div> -->
        <p>สะสมอีก <strong>50</strong> พ้อยท์ ภายใน <strong>31/12/65</strong><br>เพื่อเลื่อนสถานะเป็น <strong>Gold</strong> ในปี 2568</p>

        <button class="btn btn-primary me-2" onclick="submitData()">
<i class="fa-solid fa-qrcode"></i> สแกนคิวอาร์โค้ดรับพ้อยท์</button>
      </div>
    </div>


  
  
<div id="Ads" class="card-img-top rounded-4 mt-3">
  <div id="carouselAdsControls" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner rounded-4 overflow-hidden">
      <div class="carousel-item active">
        <img src="https://placehold.co/600x200?text=Advertise+1" class="d-block w-100" alt="Ad 1">
      </div>
      <div class="carousel-item">
        <img src="https://placehold.co/600x200?text=Advertise+2" class="d-block w-100" alt="Ad 2">
      </div>
      <div class="carousel-item">
        <img src="https://placehold.co/600x200?text=Advertise+3" class="d-block w-100" alt="Ad 3">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">ก่อนหน้า</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">ถัดไป</span>
    </button>
  </div>
</div>

  
    </div>
 
  
  
  
<script>
const serverUrl = "https://script.google.com/macros/s/AKfycbwjdxcAdyh-Qso8pY9hXIQ54v-DZliPiWMEtqcz7FITZv5_IQHRIuIVL16KlJRXR0ZSIg/exec";
const liffID = "2006777381-oyBN78kJ";
const jsonUrl = "https://opensheet.elk.sh/14ZZIYloL8GPspQl4m02U1os6P3CyCUdM5H_xtpMeWK0/Score";

$(document).ready(function () {

  
  $('#regSection').hide();

  liff.init({ liffId: liffID }).then(() => {
    if (liff.isLoggedIn()) {

$.LoadingOverlay("show", {
image: "",
fontawesome: "fa fa-spinner fa-spin",
text: "กำลังโหลดข้อมูล..."
})
      
      liff.getProfile().then(profile => {
        const uid = profile.userId;
        $('#uid').val(uid);
        $('#profilePic').attr('src', profile.pictureUrl);

        fetch(jsonUrl)
          .then(res => res.json())
          .then(data => {
            const userData = data.find(d => d.Uid === uid);
            if (userData) {
              $('#displaySection').show();
              $('#username').text(userData.Name);
              $('#phone').html(`<i class="fas fa-phone"></i> ${userData.Tel}`);
              $('.text-muted span:first').text(`ชั้น ${userData.Classroom} | รหัส ${userData.Passport}`);
              $('#profilePic').attr('src', profile.pictureUrl);

              let score = parseInt(userData.Score || "0");
              $('#points').text(score);

              const percent = score / 100;
              const totalLength = 100;
              const offset = totalLength * (1 - percent);
              document.getElementById("progressCurve").style.strokeDashoffset = offset;

              let tierText = "ระดับ Silver";
              let bgClass = "bg-silver";
              let nextTierScore = 100;

              if (score >= 350) {
                tierText = "ระดับ Diamond";
                bgClass = "bg-diamond";
                nextTierScore = 800;
              } else if (score >= 100) {
                tierText = "ระดับ Gold";
                bgClass = "bg-gold";
                nextTierScore = 350;
              }

              $('.d-flex').removeClass("bg-silver bg-gold bg-diamond").addClass(bgClass);
              $('.text-center.mt-2.mb-4.fw-bold').text(tierText);

              let remaining = nextTierScore - score;
              if (remaining > 0) {
                $('p:contains("สะสมอีก")').html(`สะสมอีก <strong>${remaining}</strong> พ้อยท์ ภายใน <strong>31/12/68</strong><br>เพื่อเลื่อนสถานะเป็น <strong>${tierText === "ระดับ Gold" ? "Diamond" : "Supreme"}</strong> ในปี 2568`);
              } else {
                $('p:contains("สะสมอีก")').html(`คุณอยู่ในระดับสูงสุดแล้ว 🎉`);
              }

            } else {
              $('#regSection').show();
              $('#displaySection').hide();
            }
            $.LoadingOverlay("hide");
          })
          .catch(error => {
            console.error("Fetch error:", error);
            $.LoadingOverlay("hide");
            Swal.fire("ผิดพลาด", "โหลดข้อมูลไม่สำเร็จ", "error");
          });
      });
    } else {
      liff.login();
    }
  }).catch(err => console.error(err));

  $('#dataForm').ajaxForm({
    url: serverUrl,
    type: 'POST',
    dataType: 'json',
    beforeSubmit: function () {
      Swal.fire({
        title: 'กำลังบันทึก...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });
    },
    success: function (response) {
      if (response.status === 'success') {
        Swal.fire({
          icon: 'success',
          title: 'ลงทะเบียนสำเร็จ!',
          text: 'ข้อมูลของคุณถูกบันทึกแล้ว'
        });

        $('#username').text($('#name').val());
        $('#phone').html('<i class="fas fa-phone"></i> ' + $('#telephone').val());
        const room = $('#room').val();
        const passport = $('#passport').val();
        $('.text-muted span:first').text(`ชั้น ${room} เลขที่ ${passport}`);
        $('#points').text('0');

        $('#regSection').hide();
        $('#displaySection').show();

        document.getElementById("progressCurve").style.strokeDashoffset = 126; // 0%
      } else {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด!',
          text: 'ไม่สามารถส่งข้อมูลได้'
        });
      }
    },
    error: function () {
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด!',
        text: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้'
      });
    }
  });
});

function submitData() {
$.LoadingOverlay("show", {
image: "",
fontawesome: "fa fa-spinner fa-spin",
text: "กำลังบันทึกข้อมูล..."
})

  const data = {
    name: $('#username').text(),
    phone: $('#phone').text().replace("📞", "").trim(),
    points: $('#points').text(),
    tier: "Silver"
  };

  fetch(serverUrl, {
    method: "POST",
    body: new URLSearchParams(data)
  })
    .then(res => res.json())
    .then(result => {
      $.LoadingOverlay("hide");
      Swal.fire("ส่งข้อมูลแล้ว", "ระบบบันทึกพ้อยท์เรียบร้อย", "success");
    })
    .catch(error => {
      $.LoadingOverlay("hide");
      Swal.fire("ผิดพลาด", "ไม่สามารถส่งข้อมูลได้", "error");
    });
}
</script>

  
  
      <footer style="font-size: 14px;">
    © <script>document.write(new Date().getFullYear());</script> Copyright | พัฒนาโดยครูสิทธิชาติ สิทธิ
    <a href="https://www.facebook.com/SanwithzWebapp" target="_blank"><i class="fa-brands fa-facebook"></i></a>
    <a href="https://www.youtube.com/@Sanwithz" target="_blank"><i class="fa-brands fa-youtube"></i></a>
  </footer>
  
</body>
</html>
